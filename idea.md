# 🕵️ PhotoFinder — Полный пайплайн системы распознавания лиц

---

## 🧱 Блок-схема уровней
```
                ┌──────────────────────────┐
                │       Админ-панель       │
                │ (загрузка фото с Я.Диска)│
                └────────────┬─────────────┘
                             │
                             ▼
         ┌────────────────────────────────────────┐
         │  ETL + Face Recognition Pipeline       │
         │ - Детекция и выравнивание лиц          │
         │ - Извлечение эмбеддингов (DeepFace)    │
         │ - Кластеризация и присвоение user_id   │
         │ - Сохранение (user_id → photo_ids)     │
         └────────────────┬───────────────────────┘
                          │
                          ▼
          ┌─────────────────────────────────┐
          │       Database / Storage        │
          │ - users: user_id, mean_embedding│
          │ - photos: photo_id, path        │
          │ - mapping: user_id ↔ photo_ids  │
          └────────────────┬────────────────┘
                           │
                           ▼
              ┌────────────────────────────┐
              │ Telegram Bot Interface     │
              │ - принимает фото           │
              │ - ищет user_id по embedding│
              │ - возвращает фото          │
              └────────────────────────────┘

```

---

## 1️⃣ Загрузка и первичная обработка фото (админ-зона)

**Цель:** загрузить пачку фото с мероприятий, распознать всех людей и распределить их по ID-пользователям.

### ⚙️ Этапы:

1. **Загрузка исходных фото**
   - Админ загружает фотографии с Яндекс.Диска или любого внешнего источника.
   - Скрипт скачивает все файлы в директорию:
     ```
     /srv/project/photos/raw_uploads/
     ```

2. **Обработка фото**
   - Для каждого изображения:
     - Детектируются лица (`MTCNN` / `RetinaFace`);
     - Производится выравнивание лица (**2D/3D alignment**);
     - Извлекается эмбеддинг лица (`ArcFace` или `AdaFace` через `InsightFace` / `DeepFace`);
     - Определяется угол поворота головы (**pose estimation**);
     - Если лицо сильно повернуто — либо пропускается, либо используется 3D-реконструкция.

3. **Сопоставление лиц с существующими пользователями**
   - Эмбеддинг сравнивается с `mean_embedding` в БД (через **FAISS** или **cosine distance**);
   - Если расстояние < `threshold` → лицо относится к уже существующему пользователю (`user_id`);
   - Если совпадений нет → создаётся новый `user_id`.

4. **Усреднение эмбеддингов (multi-view embedding)**
   - При добавлении нового фото обновляется средний вектор лица пользователя, чтобы учесть разные ракурсы.

5. **Сохранение данных**
   - Фото сохраняется локально:
     ```
     /srv/project/photos/{user_id}/{photo_id}.jpg
     ```
   - В БД добавляется запись:

     **Таблица `photos`**
     | photo_id | file_path | upload_date | meta (pose, quality) |
     |-----------|------------|--------------|----------------------|

     **Таблица `users`**
     | user_id | mean_embedding | created_at |
     |----------|----------------|-------------|

     **Таблица `user_photos`**
     | user_id | photo_id |
     |----------|-----------|

---

## 2️⃣ База данных и индексы

**Цель:** обеспечить быстрый поиск по лицам и доступ к фото.

### ⚙️ Состав:
- **PostgreSQL** — хранение метаданных, связей и путей к файлам.
- **FAISS** — быстрый поиск ближайших эмбеддингов.
- **Хранилище файлов на сервере:**
```
/srv/project/photos/
├── 0001/
│   ├── 1.jpg
│   ├── 2.jpg
├── 0002/
│   ├── 5.jpg
│   └── 6.jpg
└── ...
```

### 💾 Основные таблицы

**`users`**
| user_id | mean_embedding (vector) | created_at |
|----------|-------------------------|-------------|

**`photos`**
| photo_id | file_path | upload_date | meta (pose, quality) |
|-----------|------------|--------------|----------------------|

**`user_photos`**
| user_id | photo_id |
|----------|-----------|

---

## 3️⃣ Telegram-бот: поиск по лицу

**Цель:** пользователь загружает фото → получает все фото, где он присутствует.

### ⚙️ Этапы:

1. Пользователь отправляет фото в Telegram-бот.
2. Фото сохраняется временно в:
```
/srv/project/temp/
```
3. ML-модуль:
- Детектирует лицо, выполняет выравнивание;
- Извлекает эмбеддинг (`ArcFace` / `AdaFace`);
- Сравнивает эмбеддинг с индексом FAISS / БД;
- При совпадении ниже `threshold` возвращает `user_id`.
4. По `user_id` извлекаются все `photo_id` из `user_photos`.
5. Из таблицы `photos` достаются пути (`file_path`).
6. Бот отправляет найденные фото пользователю (постранично, например по 10 штук за раз).

---

## 4️⃣ Механизмы устойчивости и качества

✅ **Face Alignment** — выравнивание лиц в фронтальный вид перед извлечением эмбеддингов.  
✅ **Multi-view Embeddings** — усреднение векторов лиц с разных ракурсов.  
✅ **Pose Filtering** — игнорирование снимков с поворотом головы > 70°.  
✅ **Adaptive Threshold** — гибкий порог совпадения для неуверенных случаев.  
✅ **Кэширование** — эмбеддинги и пути хранятся в Redis для ускорения поиска.

---

## 5️⃣ Админ-панель

- Просмотр автоматически созданных пользователей и их фото.  
- Объединение/разделение пользователей (в случае ошибок кластеризации).  
- Удаление дублей и некачественных фото.  
- Просмотр метаданных (качество, pose, confidence и т.д.).

---

